version: "3"

env:
  MULTIPASS_BUILD_PATH:
    sh: echo {{.BUILD_PATH}}/multipass
  MULTIPASS_BUILD_KEYS_PATH:
    sh: echo {{.MULTIPASS_BUILD_PATH}}/keys
  MULTIPASS_KUBECONFIG:
    sh: echo {{.MULTIPASS_BUILD_PATH}}/{{.KUBECONFIG}}
  MULTIPASS_PROVISION_PATH:
    sh: echo {{.PROVISION_PATH}}/multipass
  MULTIPASS_MANIFEST_PATH:
    sh: echo {{.MULTIPASS_PROVISION_PATH}}/manifests
  MULTIPASS_MOUNT_PATH:
    sh: echo {{.MOUNT_PATH}}/multipass

tasks:
  check:
    desc: Exist multipass and dependences
    run: once
    deps:
      - task: check:multipass
      - task: check:mkcert

  check:mkcert:
    desc: Exist mkcert
    run: once
    preconditions:
      - sh: command -v mkcert
        msg: "Please Install mkcert"

  check:multipass:
    desc: Exist multipass
    run: once
    preconditions:
      - sh: command -v multipass
        msg: "Please Install multipass"

  make:path:
    desc: make paths
    run: once
    cmds:
      - task: make:path:build
      - task: make:path:build:keys
      - task: make:path:mount

  make:path:build:
    desc: make path build
    run: once
    cmds:
      - cmd: mkdir -p {{.MULTIPASS_BUILD_PATH}}

  make:path:build:keys:
    desc: make path build keys
    run: once
    cmds:
      - cmd: mkdir -p {{.MULTIPASS_BUILD_KEYS_PATH}}

  make:path:mount:
    run: once
    desc: make path mount
    cmds:
      - cmd: mkdir -p {{.MULTIPASS_MOUNT_PATH}}

  make:certificates:
    desc: make certificates and export.
    run: once
    deps:
      - task: check
    cmds:
      - cmd: mkcert '*.{{.K8S_DOMAIN}}'
      - cmd: mkcert -install
      - cmd: mkdir -p {{.MULTIPASS_BUILD_KEYS_PATH}}/
      - cmd: mv _wildcard.{{.K8S_DOMAIN}}.pem {{.MULTIPASS_BUILD_KEYS_PATH}}/
      - cmd: mv _wildcard.{{.K8S_DOMAIN}}-key.pem {{.MULTIPASS_BUILD_KEYS_PATH}}/
    status:
      - test -f {{.MULTIPASS_BUILD_KEYS_PATH}}/_wildcard.{{.K8S_DOMAIN}}.pem
      - test -f {{.MULTIPASS_BUILD_KEYS_PATH}}/_wildcard.{{.K8S_DOMAIN}}-key.pem

  setup:
    desc: setup multipass.
    run: once
    deps:
      - task: check:multipass
    cmds:
      - task: make:path
      - task: make:certificates

  launch:
    desc: launch multipass.
    run: once
    deps:
      - task: check:multipass
    cmds:
      - task: make:path
      - >-
        multipass launch --verbose --name {{.MULTIPASS_LAUNCH_NAME}} --cloud-init {{.MULTIPASS_CLOUD_INIT_FILE}} {{.MULTIPASS_ARGS}} {{.CLI_ARGS}}

  launch:k8s:master:
    desc: launch k8s master.
    run: once
    cmds:
      - task: launch
        vars:
          MULTIPASS_LAUNCH_NAME: k8s-master
          MULTIPASS_CLOUD_INIT_FILE: provision/multipass/kubernetes/master.yaml
          MULTIPASS_ARGS: -c 2 -m 2G --disk 20G
      - cmd: multipass exec {{.MULTIPASS_LAUNCH_NAME}} -- bash -c 'sudo kubeadm config images pull'
      - cmd: multipass exec {{.MULTIPASS_LAUNCH_NAME}} -- bash -c 'sudo kubeadm init --pod-network-cidr=10.1.0.0/16'

      - cmd: multipass exec {{.MULTIPASS_LAUNCH_NAME}} -- bash -c 'sudo systemctl restart kubelet'
      - cmd: multipass exec {{.MULTIPASS_LAUNCH_NAME}} -- bash -c 'sudo systemctl restart containerd'
      - cmd: multipass exec {{.MULTIPASS_LAUNCH_NAME}} -- bash -c 'sudo cat /etc/kubernetes/admin.conf' > {{.MULTIPASS_KUBECONFIG}}
        vars:
          MULTIPASS_LAUNCH_NAME: k8s-master
      - cmd: echo "now deploying tigera-operator ...."
      - cmd: KUBECONFIG={{.MULTIPASS_KUBECONFIG}} helm repo add projectcalico https://docs.tigera.io/calico/charts
      - cmd: KUBECONFIG={{.MULTIPASS_KUBECONFIG}} kubectl create namespace tigera-operator
      - cmd: KUBECONFIG={{.MULTIPASS_KUBECONFIG}} helm install calico projectcalico/tigera-operator --version v3.24.5 -f provision/k8s/system/calico/resources/helm/values.yaml --namespace tigera-operator
      - cmd: echo "wait ...."
      - cmd: sleep 60
      - cmd: KUBECONFIG={{.MULTIPASS_KUBECONFIG}} kubectl get pods -n calico-system
      - cmd: KUBECONFIG={{.MULTIPASS_KUBECONFIG}} kubectl get nodes -o wide
      - cmd: multipass exec {{.MULTIPASS_LAUNCH_NAME}} -- bash -c 'sudo kubeadm token create --print-join-command' > {{.MULTIPASS_BUILD_PATH}}/kubeadm_join.sh
        vars:
          MULTIPASS_LAUNCH_NAME: k8s-master
      - cmd: echo "Now deploying the worker nodes"
      - cmd: multipass mount {{.MULTIPASS_MOUNT_PATH}} {{.MULTIPASS_LAUNCH_NAME}}:/data
    vars:
      MULTIPASS_LAUNCH_NAME: k8s-master

  launch:k8s:node:
    desc: launch k8s nodes.
    run: once
    cmds:
      - task: launch
        vars:
          MULTIPASS_LAUNCH_NAME: k8s-node
          MULTIPASS_CLOUD_INIT_FILE: provision/multipass/kubernetes/node.yaml
          MULTIPASS_ARGS: -c 2 -m 2G --disk 20G
      - cmd: multipass transfer {{.MULTIPASS_BUILD_PATH}}/kubeadm_join.sh {{.MULTIPASS_LAUNCH_NAME}}:kubeadm_join.sh
      - cmd: multipass exec {{.MULTIPASS_LAUNCH_NAME}} -- bash -c 'sudo chmod +x kubeadm_join.sh'
      - cmd: multipass exec {{.MULTIPASS_LAUNCH_NAME}} -- bash -c 'sudo sh ./kubeadm_join.sh'
      - cmd: KUBECONFIG={{.MULTIPASS_KUBECONFIG}} kubectl label node {{.MULTIPASS_LAUNCH_NAME}} node-role.kubernetes.io/node=
      - cmd: KUBECONFIG={{.MULTIPASS_KUBECONFIG}} kubectl get nodes
      - cmd: multipass mount {{.MULTIPASS_MOUNT_PATH}} {{.MULTIPASS_LAUNCH_NAME}}:/data
    vars:
      MULTIPASS_LAUNCH_NAME: k8s-node

  launch:traefik:
    desc: make traefik.
    run: once
    deps:
      - task: check
    cmds:
      - task: make:certificates
      - cmd: |
          cat <<EOF | KUBECONFIG={{.MULTIPASS_KUBECONFIG}} kubectl apply -f -
          apiVersion: v1
          kind: Namespace
          metadata:
            name: traefik
          EOF
      - cmd: |
          export TLS_CRT=$(cat {{.MULTIPASS_BUILD_KEYS_PATH}}/_wildcard.{{.K8S_DOMAIN}}.pem | base64)
          export TLS_KEY=$(cat {{.MULTIPASS_BUILD_KEYS_PATH}}/_wildcard.{{.K8S_DOMAIN}}-key.pem | base64)
          cat <<EOF | KUBECONFIG={{.MULTIPASS_KUBECONFIG}} kubectl apply -f -
          apiVersion: v1
          kind: Secret
          data:
            tls.crt: $TLS_CRT
            tls.key: $TLS_KEY
          metadata:
            name: traefik-tls-cert
            namespace: traefik
          type: kubernetes.io/tls
          EOF
      - cmd: KUBECONFIG={{.MULTIPASS_KUBECONFIG}} kubectl apply -f {{.MULTIPASS_PROVISION_PATH}}/overlays/core/traefik/crd.yaml -n traefik
